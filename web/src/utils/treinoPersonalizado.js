/**
 * GERADOR DE TREINOS PERSONALIZADOS - EVOLVEYOU
 * 
 * Baseado nas respostas da anamnese inteligente (22 perguntas)
 * Considera local, experi√™ncia, frequ√™ncia, objetivo, les√µes e prefer√™ncias
 */

const { aplicarAlgoritmosCompensatorios } = require('./algoritmosCompensatorios');
const { exercicios } = require('../data/exercicios');

/**
 * Analisa as respostas da anamnese e determina par√¢metros do treino
 */
function analisarParametrosTreino(anamnese) {
  console.log('üèãÔ∏è Analisando par√¢metros para treino personalizado...');
  
  const parametros = {
    // An√°lise do local de treino
    local: determinarLocalTreino(anamnese.local_treino),
    
    // An√°lise da experi√™ncia
    experiencia: determinarExperiencia(anamnese.experiencia_treino),
    
    // An√°lise da frequ√™ncia
    frequencia: determinarFrequencia(anamnese.frequencia_treino),
    
    // An√°lise do objetivo
    objetivo: determinarObjetivo(anamnese.objetivo_principal),
    
    // An√°lise das atividades praticadas
    atividades: analisarAtividades(anamnese.atividades_praticadas),
    
    // An√°lise de les√µes/limita√ß√µes
    limitacoes: analisarLimitacoes(anamnese.lesoes_dores),
    
    // An√°lise da intensidade preferida
    intensidade: determinarIntensidade(anamnese.intensidade_treino),
    
    // An√°lise do tempo dispon√≠vel
    tempoDisponivel: determinarTempo(anamnese.tempo_treino),
    
    // Dados f√≠sicos
    dadosFisicos: {
      peso: parseFloat(anamnese.peso),
      altura: parseFloat(anamnese.altura),
      idade: parseInt(anamnese.idade),
      sexo: anamnese.sexo
    }
  };
  
  console.log('üìä Par√¢metros analisados:', parametros);
  return parametros;
}

/**
 * Determina o local de treino baseado na resposta
 */
function determinarLocalTreino(localResposta) {
  if (!localResposta) return 'casa';
  
  if (localResposta.includes('Casa')) return 'casa';
  if (localResposta.includes('Academia b√°sica')) return 'academia_basica';
  if (localResposta.includes('Academia completa')) return 'academia_completa';
  if (localResposta.includes('CrossFit')) return 'crossfit';
  if (localResposta.includes('Ao ar livre')) return 'ar_livre';
  
  return 'casa'; // Default
}

/**
 * Determina o n√≠vel de experi√™ncia
 */
function determinarExperiencia(experienciaResposta) {
  if (!experienciaResposta) return 'iniciante';
  
  if (experienciaResposta.includes('Nunca treinei') || 
      experienciaResposta.includes('Menos de 6 meses')) {
    return 'iniciante';
  }
  
  if (experienciaResposta.includes('6 meses a 2 anos') ||
      experienciaResposta.includes('2 a 5 anos')) {
    return 'intermediario';
  }
  
  if (experienciaResposta.includes('Mais de 5 anos') ||
      experienciaResposta.includes('Atleta/competidor')) {
    return 'avancado';
  }
  
  return 'iniciante'; // Default
}

/**
 * Determina a frequ√™ncia de treino
 */
function determinarFrequencia(frequenciaResposta) {
  if (!frequenciaResposta) return 3;
  
  if (frequenciaResposta.includes('1 a 2')) return 2;
  if (frequenciaResposta.includes('3 a 4')) return 3;
  if (frequenciaResposta.includes('5 a 6')) return 5;
  if (frequenciaResposta.includes('Todos os dias')) return 7;
  
  return 3; // Default
}

/**
 * Determina o objetivo principal
 */
function determinarObjetivo(objetivoResposta) {
  if (!objetivoResposta) return 'geral';
  
  if (objetivoResposta.includes('Emagrecer')) return 'emagrecimento';
  if (objetivoResposta.includes('Ganhar massa')) return 'hipertrofia';
  if (objetivoResposta.includes('Melhorar condicionamento')) return 'condicionamento';
  if (objetivoResposta.includes('Aumentar for√ßa')) return 'forca';
  if (objetivoResposta.includes('Sa√∫de geral')) return 'saude';
  
  return 'geral'; // Default
}

/**
 * Analisa atividades praticadas
 */
function analisarAtividades(atividadesResposta) {
  const atividades = {
    musculacao: false,
    cardio: false,
    esportes: false,
    funcional: false,
    yoga: false,
    natacao: false
  };
  
  if (!atividadesResposta || !Array.isArray(atividadesResposta)) {
    return atividades;
  }
  
  atividadesResposta.forEach(atividade => {
    if (atividade.includes('Muscula√ß√£o')) atividades.musculacao = true;
    if (atividade.includes('Cardio') || atividade.includes('Corrida')) atividades.cardio = true;
    if (atividade.includes('Esportes')) atividades.esportes = true;
    if (atividade.includes('Funcional') || atividade.includes('CrossFit')) atividades.funcional = true;
    if (atividade.includes('Yoga') || atividade.includes('Pilates')) atividades.yoga = true;
    if (atividade.includes('Nata√ß√£o')) atividades.natacao = true;
  });
  
  return atividades;
}

/**
 * Analisa les√µes e limita√ß√µes
 */
function analisarLimitacoes(lesoesResposta) {
  const limitacoes = {
    joelho: false,
    lombar: false,
    ombro: false,
    punho: false,
    pescoco: false,
    tornozelo: false,
    nenhuma: false
  };
  
  if (!lesoesResposta) {
    limitacoes.nenhuma = true;
    return limitacoes;
  }
  
  if (lesoesResposta.includes('N√£o tenho')) {
    limitacoes.nenhuma = true;
    return limitacoes;
  }
  
  if (lesoesResposta.includes('Joelho')) limitacoes.joelho = true;
  if (lesoesResposta.includes('Lombar') || lesoesResposta.includes('Coluna')) limitacoes.lombar = true;
  if (lesoesResposta.includes('Ombro')) limitacoes.ombro = true;
  if (lesoesResposta.includes('Punho')) limitacoes.punho = true;
  if (lesoesResposta.includes('Pesco√ßo')) limitacoes.pescoco = true;
  if (lesoesResposta.includes('Tornozelo')) limitacoes.tornozelo = true;
  
  return limitacoes;
}

/**
 * Determina intensidade preferida
 */
function determinarIntensidade(intensidadeResposta) {
  if (!intensidadeResposta) return 'moderada';
  
  if (intensidadeResposta.includes('Leve')) return 'leve';
  if (intensidadeResposta.includes('Moderada')) return 'moderada';
  if (intensidadeResposta.includes('Intensa')) return 'intensa';
  if (intensidadeResposta.includes('Muito intensa')) return 'muito_intensa';
  
  return 'moderada'; // Default
}

/**
 * Determina tempo dispon√≠vel
 */
function determinarTempo(tempoResposta) {
  if (!tempoResposta) return 45;
  
  if (tempoResposta.includes('30')) return 30;
  if (tempoResposta.includes('45')) return 45;
  if (tempoResposta.includes('60')) return 60;
  if (tempoResposta.includes('90')) return 90;
  
  return 45; // Default
}

/**
 * Seleciona divis√£o de treino baseada na experi√™ncia e frequ√™ncia
 */
function selecionarDivisaoTreino(parametros) {
  const { experiencia, frequencia, objetivo } = parametros;
  
  // L√≥gica de sele√ß√£o de divis√£o
  if (frequencia <= 2) {
    return 'full_body'; // Full Body para baixa frequ√™ncia
  }
  
  if (experiencia === 'iniciante') {
    if (frequencia <= 3) return 'full_body';
    return 'upper_lower'; // Upper/Lower para iniciantes com mais frequ√™ncia
  }
  
  if (experiencia === 'intermediario') {
    if (frequencia <= 3) return 'upper_lower';
    if (frequencia <= 4) return 'abc';
    return 'push_pull_legs'; // Push/Pull/Legs para intermedi√°rios
  }
  
  if (experiencia === 'avancado') {
    if (frequencia <= 3) return 'upper_lower';
    if (frequencia <= 5) return 'push_pull_legs';
    return 'especializada'; // Divis√£o especializada para avan√ßados
  }
  
  return 'full_body'; // Default
}

/**
 * Filtra exerc√≠cios baseado no local e limita√ß√µes
 */
function filtrarExercicios(parametros) {
  const { local, limitacoes } = parametros;
  
  let exerciciosFiltrados = { ...exercicios };
  
  // Filtrar por local
  Object.keys(exerciciosFiltrados).forEach(categoria => {
    exerciciosFiltrados[categoria] = exerciciosFiltrados[categoria].filter(exercicio => {
      // Verificar se o exerc√≠cio √© adequado para o local
      if (local === 'casa' && exercicio.equipamento && 
          !['peso_corporal', 'halteres', 'elastico'].includes(exercicio.equipamento)) {
        return false;
      }
      
      if (local === 'academia_basica' && exercicio.equipamento === 'maquinas_especializadas') {
        return false;
      }
      
      return true;
    });
  });
  
  // Filtrar por limita√ß√µes
  if (!limitacoes.nenhuma) {
    Object.keys(exerciciosFiltrados).forEach(categoria => {
      exerciciosFiltrados[categoria] = exerciciosFiltrados[categoria].filter(exercicio => {
        // Remover exerc√≠cios que podem agravar les√µes
        if (limitacoes.joelho && exercicio.articulacoes?.includes('joelho') && 
            exercicio.impacto === 'alto') {
          return false;
        }
        
        if (limitacoes.lombar && exercicio.articulacoes?.includes('lombar') && 
            exercicio.tipo === 'composto') {
          return false;
        }
        
        if (limitacoes.ombro && exercicio.articulacoes?.includes('ombro') && 
            exercicio.movimento?.includes('overhead')) {
          return false;
        }
        
        return true;
      });
    });
  }
  
  return exerciciosFiltrados;
}

/**
 * Calcula s√©ries, repeti√ß√µes e carga baseado nos par√¢metros
 */
function calcularParametrosTreino(parametros) {
  const { experiencia, objetivo, intensidade, dadosFisicos } = parametros;
  
  let series, repeticoes, descanso, cargaBase;
  
  // Configura√ß√£o baseada no objetivo
  switch (objetivo) {
    case 'forca':
      series = experiencia === 'iniciante' ? 3 : experiencia === 'intermediario' ? 4 : 5;
      repeticoes = '3-5';
      descanso = '3-5 min';
      cargaBase = dadosFisicos.peso * 0.8;
      break;
      
    case 'hipertrofia':
      series = experiencia === 'iniciante' ? 3 : 4;
      repeticoes = '8-12';
      descanso = '60-90 seg';
      cargaBase = dadosFisicos.peso * 0.6;
      break;
      
    case 'emagrecimento':
      series = 3;
      repeticoes = '12-15';
      descanso = '30-60 seg';
      cargaBase = dadosFisicos.peso * 0.5;
      break;
      
    case 'condicionamento':
      series = 3;
      repeticoes = '15-20';
      descanso = '30-45 seg';
      cargaBase = dadosFisicos.peso * 0.4;
      break;
      
    default:
      series = 3;
      repeticoes = '10-12';
      descanso = '60 seg';
      cargaBase = dadosFisicos.peso * 0.5;
  }
  
  // Ajustar pela intensidade
  const multiplicadorIntensidade = {
    'leve': 0.7,
    'moderada': 1.0,
    'intensa': 1.3,
    'muito_intensa': 1.5
  };
  
  cargaBase *= multiplicadorIntensidade[intensidade] || 1.0;
  
  // Ajustar pela experi√™ncia
  const multiplicadorExperiencia = {
    'iniciante': 0.8,
    'intermediario': 1.0,
    'avancado': 1.2
  };
  
  cargaBase *= multiplicadorExperiencia[experiencia] || 1.0;
  
  return {
    series,
    repeticoes,
    descanso,
    cargaBase: Math.round(cargaBase)
  };
}

/**
 * Gera treino para um dia espec√≠fico
 */
function gerarTreinoDia(parametros, divisao, diaSemana, exerciciosFiltrados) {
  const parametrosTreino = calcularParametrosTreino(parametros);
  
  // Determinar grupos musculares para o dia
  const gruposMusculares = determinarGruposMusculares(divisao, diaSemana);
  
  if (gruposMusculares.includes('descanso')) {
    return {
      tipo: 'descanso',
      titulo: 'Dia de Descanso',
      descricao: 'Dia dedicado ao descanso e recupera√ß√£o muscular',
      atividades: [
        'Caminhada leve (20-30 min)',
        'Alongamento (10-15 min)',
        'Hidrata√ß√£o adequada',
        'Sono reparador (7-9 horas)'
      ]
    };
  }
  
  const treino = {
    tipo: 'treino',
    titulo: `Treino ${divisao.toUpperCase()} - ${gruposMusculares.join('/')}`,
    gruposMusculares,
    duracao: parametros.tempoDisponivel,
    exercicios: [],
    observacoes: []
  };
  
  // Selecionar exerc√≠cios para cada grupo muscular
  gruposMusculares.forEach(grupo => {
    const exerciciosGrupo = exerciciosFiltrados[grupo] || [];
    
    if (exerciciosGrupo.length > 0) {
      // Selecionar 2-3 exerc√≠cios por grupo muscular
      const numExercicios = parametros.experiencia === 'iniciante' ? 2 : 
                           parametros.experiencia === 'intermediario' ? 3 : 4;
      
      for (let i = 0; i < Math.min(numExercicios, exerciciosGrupo.length); i++) {
        const exercicio = exerciciosGrupo[i];
        
        treino.exercicios.push({
          nome: exercicio.nome,
          grupo: grupo,
          series: parametrosTreino.series,
          repeticoes: parametrosTreino.repeticoes,
          descanso: parametrosTreino.descanso,
          carga: calcularCargaExercicio(exercicio, parametrosTreino.cargaBase),
          instrucoes: exercicio.instrucoes || 'Execute o movimento de forma controlada',
          equipamento: exercicio.equipamento || 'peso_corporal',
          dificuldade: exercicio.dificuldade || parametros.experiencia
        });
      }
    }
  });
  
  // Adicionar observa√ß√µes personalizadas
  treino.observacoes = gerarObservacoesTreino(parametros, treino);
  
  return treino;
}

/**
 * Determina grupos musculares para cada dia baseado na divis√£o
 */
function determinarGruposMusculares(divisao, diaSemana) {
  const divisoes = {
    full_body: {
      1: ['peito', 'costas', 'pernas', 'ombros'],
      2: ['descanso'],
      3: ['peito', 'costas', 'pernas', 'bracos'],
      4: ['descanso'],
      5: ['peito', 'costas', 'pernas', 'core'],
      6: ['descanso'],
      7: ['descanso']
    },
    
    upper_lower: {
      1: ['peito', 'costas', 'ombros', 'bracos'],
      2: ['pernas', 'gluteos', 'core'],
      3: ['descanso'],
      4: ['peito', 'costas', 'ombros', 'bracos'],
      5: ['pernas', 'gluteos', 'core'],
      6: ['descanso'],
      7: ['descanso']
    },
    
    abc: {
      1: ['peito', 'triceps', 'ombros'], // A
      2: ['costas', 'biceps'], // B
      3: ['pernas', 'gluteos', 'core'], // C
      4: ['descanso'],
      5: ['peito', 'triceps', 'ombros'], // A
      6: ['costas', 'biceps'], // B
      7: ['descanso']
    },
    
    push_pull_legs: {
      1: ['peito', 'ombros', 'triceps'], // Push
      2: ['costas', 'biceps'], // Pull
      3: ['pernas', 'gluteos'], // Legs
      4: ['descanso'],
      5: ['peito', 'ombros', 'triceps'], // Push
      6: ['costas', 'biceps'], // Pull
      7: ['pernas', 'gluteos'] // Legs
    }
  };
  
  return divisoes[divisao]?.[diaSemana] || ['descanso'];
}

/**
 * Calcula carga espec√≠fica para um exerc√≠cio
 */
function calcularCargaExercicio(exercicio, cargaBase) {
  if (exercicio.equipamento === 'peso_corporal') {
    return 'Peso corporal';
  }
  
  // Multiplicadores por tipo de exerc√≠cio
  const multiplicadores = {
    'composto': 1.0,
    'isolado': 0.6,
    'funcional': 0.8
  };
  
  const multiplicador = multiplicadores[exercicio.tipo] || 0.8;
  const carga = Math.round(cargaBase * multiplicador);
  
  // Ajustar para m√∫ltiplos de 2.5kg (padr√£o de academia)
  return Math.round(carga / 2.5) * 2.5;
}

/**
 * Gera observa√ß√µes personalizadas para o treino
 */
function gerarObservacoesTreino(parametros, treino) {
  const observacoes = [];
  
  // Observa√ß√µes baseadas na experi√™ncia
  if (parametros.experiencia === 'iniciante') {
    observacoes.push('üî∞ Foque na execu√ß√£o correta antes de aumentar a carga');
    observacoes.push('‚è∞ Respeite os tempos de descanso para recupera√ß√£o adequada');
  } else if (parametros.experiencia === 'avancado') {
    observacoes.push('üí™ Considere t√©cnicas avan√ßadas como drop-sets ou supersets');
    observacoes.push('üìà Monitore a progress√£o de carga semanalmente');
  }
  
  // Observa√ß√µes baseadas no objetivo
  if (parametros.objetivo === 'emagrecimento') {
    observacoes.push('üî• Mantenha intensidade alta para maximizar gasto cal√≥rico');
    observacoes.push('‚è±Ô∏è Considere reduzir o descanso entre s√©ries');
  } else if (parametros.objetivo === 'hipertrofia') {
    observacoes.push('üéØ Foque na conex√£o mente-m√∫sculo durante cada repeti√ß√£o');
    observacoes.push('üìä Aumente a carga quando conseguir fazer todas as s√©ries facilmente');
  }
  
  // Observa√ß√µes baseadas em limita√ß√µes
  if (!parametros.limitacoes.nenhuma) {
    observacoes.push('‚ö†Ô∏è Exerc√≠cios adaptados para suas limita√ß√µes f√≠sicas');
    observacoes.push('ü©∫ Pare imediatamente se sentir dor ou desconforto');
  }
  
  // Observa√ß√µes baseadas no local
  if (parametros.local === 'casa') {
    observacoes.push('üè† Treino adaptado para execu√ß√£o em casa');
    observacoes.push('üí° Use objetos dom√©sticos como peso adicional se necess√°rio');
  }
  
  observacoes.push('üíß Mantenha-se hidratado durante todo o treino');
  observacoes.push('üì± Use o sistema de check-in para acompanhar seu progresso');
  
  return observacoes;
}

/**
 * Gera programa de treino completo (7 dias)
 */
function gerarTreinoPersonalizado(anamnese) {
  console.log('üèãÔ∏è Gerando treino personalizado...');
  
  // 1. Analisar par√¢metros da anamnese
  const parametros = analisarParametrosTreino(anamnese);
  
  // 2. Selecionar divis√£o de treino
  const divisao = selecionarDivisaoTreino(parametros);
  
  // 3. Filtrar exerc√≠cios por local e limita√ß√µes
  const exerciciosFiltrados = filtrarExercicios(parametros);
  
  // 4. Gerar treino para cada dia da semana
  const programaSemanal = {
    informacoes: {
      divisao,
      frequenciaSemanal: parametros.frequencia,
      duracaoSessao: parametros.tempoDisponivel,
      objetivo: parametros.objetivo,
      experiencia: parametros.experiencia,
      local: parametros.local
    },
    treinos: {}
  };
  
  // Gerar treinos para cada dia da semana
  for (let dia = 1; dia <= 7; dia++) {
    const nomeDia = ['', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'][dia];
    
    programaSemanal.treinos[nomeDia] = gerarTreinoDia(
      parametros, 
      divisao, 
      dia, 
      exerciciosFiltrados
    );
  }
  
  // 5. Adicionar recomenda√ß√µes gerais
  programaSemanal.recomendacoes = gerarRecomendacoesGerais(parametros);
  
  console.log('‚úÖ Treino personalizado gerado:', programaSemanal);
  
  return programaSemanal;
}

/**
 * Gera recomenda√ß√µes gerais para o programa
 */
function gerarRecomendacoesGerais(parametros) {
  const recomendacoes = [];
  
  // Recomenda√ß√µes baseadas na frequ√™ncia
  if (parametros.frequencia <= 2) {
    recomendacoes.push('üìÖ Com baixa frequ√™ncia, foque em exerc√≠cios compostos');
    recomendacoes.push('üí™ Cada treino deve trabalhar o corpo todo');
  } else if (parametros.frequencia >= 5) {
    recomendacoes.push('üîÑ Alta frequ√™ncia permite maior especializa√ß√£o');
    recomendacoes.push('üò¥ Garanta pelo menos 1 dia de descanso completo');
  }
  
  // Recomenda√ß√µes baseadas no objetivo
  if (parametros.objetivo === 'emagrecimento') {
    recomendacoes.push('üèÉ Combine treino com atividade cardiovascular');
    recomendacoes.push('üçΩÔ∏è Mantenha d√©ficit cal√≥rico atrav√©s da dieta');
  } else if (parametros.objetivo === 'hipertrofia') {
    recomendacoes.push('ü•© Consuma prote√≠na adequada (1.6-2.2g/kg)');
    recomendacoes.push('üò¥ Priorize sono de qualidade para recupera√ß√£o');
  }
  
  // Recomenda√ß√µes baseadas na experi√™ncia
  if (parametros.experiencia === 'iniciante') {
    recomendacoes.push('üìö Considere aulas ou personal trainer inicialmente');
    recomendacoes.push('üìà Progress√£o gradual √© mais importante que intensidade');
  }
  
  recomendacoes.push('üìä Registre seus treinos para acompanhar evolu√ß√£o');
  recomendacoes.push('üéØ Reavalie o programa a cada 4-6 semanas');
  
  return recomendacoes;
}

/**
 * Gera varia√ß√µes do treino para evitar monotonia
 */
function gerarVariacoesTreino(programaBase, numeroSemanas = 4) {
  const variacoes = [programaBase]; // Semana 1 √© o programa base
  
  for (let semana = 2; semana <= numeroSemanas; semana++) {
    const variacao = JSON.parse(JSON.stringify(programaBase)); // Deep copy
    
    // Variar exerc√≠cios mantendo grupos musculares
    Object.keys(variacao.treinos).forEach(dia => {
      const treino = variacao.treinos[dia];
      
      if (treino.tipo === 'treino') {
        treino.exercicios = treino.exercicios.map(exercicio => {
          // 30% de chance de trocar por exerc√≠cio equivalente
          if (Math.random() < 0.3) {
            return gerarExercicioEquivalente(exercicio);
          }
          return exercicio;
        });
      }
    });
    
    variacoes.push(variacao);
  }
  
  return variacoes;
}

/**
 * Gera exerc√≠cio equivalente para o mesmo grupo muscular
 */
function gerarExercicioEquivalente(exercicioOriginal) {
  // L√≥gica simplificada - em produ√ß√£o, usar base de equival√™ncias
  const equivalencias = {
    'Flex√£o de bra√ßo': ['Flex√£o inclinada', 'Flex√£o com joelhos', 'Flex√£o diamante'],
    'Agachamento': ['Agachamento sumo', 'Agachamento b√∫lgaro', 'Agachamento jump'],
    'Prancha': ['Prancha lateral', 'Prancha com eleva√ß√£o', 'Prancha din√¢mica']
  };
  
  const equivalentes = equivalencias[exercicioOriginal.nome];
  if (equivalentes && equivalentes.length > 0) {
    const novoNome = equivalentes[Math.floor(Math.random() * equivalentes.length)];
    return {
      ...exercicioOriginal,
      nome: novoNome
    };
  }
  
  return exercicioOriginal;
}

module.exports = {
  gerarTreinoPersonalizado,
  analisarParametrosTreino,
  selecionarDivisaoTreino,
  filtrarExercicios,
  gerarTreinoDia,
  gerarVariacoesTreino,
  gerarRecomendacoesGerais
};

